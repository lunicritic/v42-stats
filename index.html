<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>V4.2 Stat Grid</title>

<style>
  :root{
    --bg:#000;
    --grid:#2b2b2b;
    --head:#101010;
    --text:#fff;

    /* tuned compactness */
    --headerH: 34px;
    --rowH: 26px;

    /* NEW: slightly tighter to help Misc Errors fit */
    --roleW: 40px;
    --playerW: 160px;

    --fontH: 10px;  /* header */
    --fontB: 12px;  /* body */
  }

  html, body{
    height:100%;
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family:-apple-system, system-ui, Arial, sans-serif;
    overflow:hidden;
  }

  /* Top controls bar */
  .topbar{
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px 10px 8px;
    border-bottom:1px solid #1b1b1b;
    flex-wrap:wrap;
  }
  .topbar .group{
    display:flex;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
  }
  .topbar label{
    font-size:12px;
    opacity:.9;
    white-space:nowrap;
  }
  input[type="text"], textarea{
    height:28px;
    border-radius:8px;
    border:1px solid #2a2a2a;
    background:#0d0d0d;
    color:#fff;
    padding:0 10px;
    font-size:13px;
    outline:none;
  }
  input[type="color"]{
    height:28px;
    width:40px;
    border-radius:8px;
    border:1px solid #2a2a2a;
    background:#0d0d0d;
    padding:0;
  }

  button{
    height:30px;
    border-radius:10px;
    border:1px solid #2a2a2a;
    background:#121212;
    color:#fff;
    font-size:13px;
    padding:0 12px;
    white-space:nowrap;
  }
  button:active{ transform:translateY(1px); }
  button:disabled{ opacity:.45; }

  .spacer{ flex:1; }

  /* Bulk paste panel */
  .bulkPanel{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:8px 10px 10px;
    border-bottom:1px solid #1b1b1b;
  }
  .bulkPanel .box{
    flex:1;
    min-width:260px;
  }
  .bulkPanel textarea{
    width:100%;
    height:86px;
    padding:8px 10px;
    border-radius:10px;
    resize:none;
    line-height:1.15;
    font-size:12px;
    white-space:pre-wrap;
  }
  .bulkPanel .hint{
    font-size:11px;
    opacity:.75;
    margin-top:6px;
  }
  .bulkPanel .actions{
    display:flex;
    flex-direction:column;
    gap:8px;
    padding-top:2px;
  }

  /* Table container */
  .tableWrap{
    height: calc(100vh - 52px - 118px); /* topbar + bulkPanel */
    width: 100vw;
    overflow:hidden;
  }

  table{
    border-collapse:collapse;
    table-layout:fixed;
    width:100vw;
    height:100%;
  }

  th, td{
    border:1px solid var(--grid);
    text-align:center;
    padding:0;
    line-height:1;
    user-select:none;
  }

  thead th{
    background:var(--head);
    font-weight:700;
    font-size:var(--fontH);
    height:var(--headerH);
  }

  /* Role column */
  th.role, td.role{
    width:var(--roleW);
    background:#050505;
    font-size:var(--fontB);
    font-weight:700;
  }

  /* Player column */
  th.player, td.player{
    width:var(--playerW);
    text-align:left;
    padding-left:8px;
    background:#050505;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:var(--fontB);
  }

  /* Stat columns: distribute remaining width evenly across 19 stats */
  th.stat, td.stat{
    width: calc((100vw - var(--roleW) - var(--playerW)) / 19);
  }

  tbody td{
    height:var(--rowH);
    font-size:var(--fontB);
  }

  td.stat{
    cursor:pointer;
  }

  td.stat:active{
    background:#0f0;
    color:#000;
  }

  /* Team separator rows */
  tr.sep td{
    height: 18px;
    font-size: 12px;
    font-weight: 800;
    letter-spacing: .2px;
    color:#000;
    text-align:left;
    padding-left:10px;
    border-top: 1px solid #000;
    border-bottom: 1px solid #000;
  }

  [contenteditable]{
    -webkit-user-select:text;
    user-select:text;
  }
</style>
</head>

<body>

<div class="topbar">
  <div class="group">
    <label>Team A</label>
    <input id="teamAName" type="text" value="Team A" />
    <input id="teamAColor" type="color" value="#2aa2ff" title="Team A separator colour" />
    <label>Captain</label>
    <input id="teamACap" type="text" placeholder="C username" />
    <label>Vice</label>
    <input id="teamAVice" type="text" placeholder="V username" />
  </div>

  <div class="group">
    <label>Team B</label>
    <input id="teamBName" type="text" value="Team B" />
    <input id="teamBColor" type="color" value="#888888" title="Team B separator colour" />
    <label>Captain</label>
    <input id="teamBCap" type="text" placeholder="C username" />
    <label>Vice</label>
    <input id="teamBVice" type="text" placeholder="V username" />
  </div>

  <div class="spacer"></div>

  <button id="undoBtn" disabled>Undo</button>
  <button id="redoBtn" disabled>Redo</button>
  <button id="resetBtn">Reset</button>
  <button id="exportBtn">Export CSV</button>
</div>

<div class="bulkPanel">
  <div class="box">
    <label style="font-size:12px;opacity:.9;">Bulk paste roster (Team A then Team B, one username per line)</label>
    <textarea id="bulkRoster" placeholder="Example:
gum_umbxll
lani
...
(12 lines for Team A)
...
(12 lines for Team B)"></textarea>
    <div class="hint">
      Tip: paste 12 lines = Team A only. Paste 24 lines = Team A + Team B. Extra lines are ignored.
    </div>
  </div>

  <div class="actions">
    <button id="applyRosterBtn">Apply roster</button>
    <button id="clearRosterBtn">Clear box</button>
  </div>
</div>

<div class="tableWrap">
  <table id="grid">
    <thead>
      <tr>
        <th class="role"> </th>
        <th class="player">Player</th>
        <th class="stat">Ape Kills</th>
        <th class="stat">Ape Attempts</th>
        <th class="stat">Ape Errors</th>
        <th class="stat">Spike Kills</th>
        <th class="stat">Spike Attempts</th>
        <th class="stat">Spike Errors</th>
        <th class="stat">Kill Blocks</th>
        <th class="stat">Stuff Blocks</th>
        <th class="stat">Soft Blocks</th>
        <th class="stat">Block Errors</th>
        <th class="stat">Assists</th>
        <th class="stat">Set Errors</th>
        <th class="stat">Spike Recs</th>
        <th class="stat">Rec Attempts</th>
        <th class="stat">BFs</th>
        <th class="stat">Receive Errors</th>
        <th class="stat">Service Aces</th>
        <th class="stat">Serve Errors</th>
        <th class="stat">Misc. Errors</th>
      </tr>
    </thead>

    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ---------- config ---------- */
const STATS = [
  "Ape Kills","Ape Attempts","Ape Errors",
  "Spike Kills","Spike Attempts","Spike Errors",
  "Kill Blocks","Stuff Blocks","Soft Blocks","Block Errors",
  "Assists","Set Errors",
  "Spike Recs","Rec Attempts","BFs","Receive Errors",
  "Service Aces","Serve Errors","Misc. Errors"
];

const ROWS_PER_TEAM = 12;
const TOTAL_ROWS = ROWS_PER_TEAM * 2;

// Default role labels like your sheet
const ROLE_LABELS_A = ["C","V","3","4","5","6","7","8","9","10","11","12"];
const ROLE_LABELS_B = ["C","V","3","4","5","6","7","8","9","10","11","12"];

/* ---------- state ---------- */
const state = {
  names: Array.from({length: TOTAL_ROWS}, (_,i)=> i<ROWS_PER_TEAM ? `Player ${i+1}` : `Opponent ${i-ROWS_PER_TEAM+1}`),
  values: Array.from({length: TOTAL_ROWS}, ()=> Array.from({length: STATS.length}, ()=> 0)),

  teamAName: "Team A",
  teamBName: "Team B",
  teamAColor: "#2aa2ff",
  teamBColor: "#888888",

  teamACap: "",
  teamAVice: "",
  teamBCap: "",
  teamBVice: ""
};

// history for undo/redo
const undoStack = [];
const redoStack = [];

/* ---------- helpers ---------- */
function pushAction(action){
  undoStack.push(action);
  redoStack.length = 0;
  updateUndoRedoButtons();
}

function updateUndoRedoButtons(){
  document.getElementById("undoBtn").disabled = undoStack.length === 0;
  document.getElementById("redoBtn").disabled = redoStack.length === 0;
}

function applyAction(action, direction){
  const {r,c,delta} = action;
  state.values[r][c] = Math.max(0, state.values[r][c] + (delta * direction));
  const cell = document.getElementById(cellId(r,c));
  if(cell) cell.textContent = state.values[r][c] ? String(state.values[r][c]) : "";
}

function cellId(r,c){ return `cell_${r}_${c}`; }
function nameId(r){ return `name_${r}`; }

function saveToLocal(){
  try{
    localStorage.setItem("v42_state", JSON.stringify(state));
  }catch(e){}
}

function loadFromLocal(){
  try{
    const raw = localStorage.getItem("v42_state");
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(parsed && parsed.names && parsed.values){
      Object.assign(state, parsed);
    }
  }catch(e){}
}

function normalizeLines(text){
  return text
    .replace(/\r\n/g, "\n")
    .replace(/\r/g, "\n")
    .split("\n")
    .map(s=>s.trim())
    .filter(s=>s.length>0);
}

/* Applies captain/vice labels to the first two rows if the names match anywhere,
   but we also keep the role column fixed as C/V/3..12 for each team (like your sheet). */
function autoPlaceCaptains(){
  // If you want later: move captain/vice to the matching username row automatically.
  // For now, the role column is fixed like your sheet, and these are informational fields for export.
}

/* ---------- render ---------- */
function render(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  // Team A separator row
  tbody.appendChild(makeSepRow(state.teamAName, state.teamAColor));

  for(let r=0; r<ROWS_PER_TEAM; r++){
    tbody.appendChild(makePlayerRow(r, ROLE_LABELS_A[r]));
  }

  // Team B separator row
  tbody.appendChild(makeSepRow(state.teamBName, state.teamBColor));

  for(let r=ROWS_PER_TEAM; r<TOTAL_ROWS; r++){
    tbody.appendChild(makePlayerRow(r, ROLE_LABELS_B[r-ROWS_PER_TEAM]));
  }

  // top inputs
  document.getElementById("teamAName").value = state.teamAName;
  document.getElementById("teamBName").value = state.teamBName;
  document.getElementById("teamAColor").value = state.teamAColor;
  document.getElementById("teamBColor").value = state.teamBColor;

  document.getElementById("teamACap").value = state.teamACap || "";
  document.getElementById("teamAVice").value = state.teamAVice || "";
  document.getElementById("teamBCap").value = state.teamBCap || "";
  document.getElementById("teamBVice").value = state.teamBVice || "";
}

function makeSepRow(label, hex){
  const tr = document.createElement("tr");
  tr.className = "sep";

  const td = document.createElement("td");
  td.colSpan = 21; // role + player + 19 stats
  td.style.background = hex;
  td.textContent = label;

  tr.appendChild(td);
  return tr;
}

function makePlayerRow(r, roleLabel){
  const tr = document.createElement("tr");

  // role cell
  const tdRole = document.createElement("td");
  tdRole.className = "role";
  tdRole.textContent = roleLabel;
  tr.appendChild(tdRole);

  // player name cell (editable)
  const tdName = document.createElement("td");
  tdName.className = "player";
  tdName.contentEditable = "true";
  tdName.id = nameId(r);
  tdName.textContent = state.names[r] || "";
  tdName.addEventListener("input", ()=>{
    state.names[r] = tdName.textContent.trim();
    saveToLocal();
  });
  tr.appendChild(tdName);

  // stat cells
  for(let c=0; c<STATS.length; c++){
    const td = document.createElement("td");
    td.className = "stat";
    td.id = cellId(r,c);
    const v = state.values[r][c];
    td.textContent = v ? String(v) : "";

    td.addEventListener("click", ()=>{
      state.values[r][c] = (state.values[r][c] || 0) + 1;
      td.textContent = String(state.values[r][c]);
      pushAction({r,c,delta:1});
      saveToLocal();
    });

    tr.appendChild(td);
  }

  return tr;
}

/* ---------- controls ---------- */
document.getElementById("undoBtn").addEventListener("click", ()=>{
  const action = undoStack.pop();
  if(!action) return;
  applyAction(action, -1);
  redoStack.push(action);
  updateUndoRedoButtons();
  saveToLocal();
});

document.getElementById("redoBtn").addEventListener("click", ()=>{
  const action = redoStack.pop();
  if(!action) return;
  applyAction(action, +1);
  undoStack.push(action);
  updateUndoRedoButtons();
  saveToLocal();
});

document.getElementById("resetBtn").addEventListener("click", ()=>{
  for(let r=0;r<TOTAL_ROWS;r++){
    for(let c=0;c<STATS.length;c++){
      state.values[r][c]=0;
    }
  }
  undoStack.length = 0;
  redoStack.length = 0;
  updateUndoRedoButtons();
  render();
  saveToLocal();
});

document.getElementById("exportBtn").addEventListener("click", ()=>{
  const header = ["Role","Player", ...STATS];
  const rows = [header];

  rows.push([`== ${state.teamAName} ==`, `Captain: ${state.teamACap || ""} | Vice: ${state.teamAVice || ""}`, ...Array(STATS.length).fill("")]);
  for(let r=0;r<ROWS_PER_TEAM;r++){
    rows.push([ROLE_LABELS_A[r], state.names[r] || "", ...state.values[r].map(v=> v?String(v):"")]);
  }

  rows.push([`== ${state.teamBName} ==`, `Captain: ${state.teamBCap || ""} | Vice: ${state.teamBVice || ""}`, ...Array(STATS.length).fill("")]);
  for(let r=ROWS_PER_TEAM;r<TOTAL_ROWS;r++){
    rows.push([ROLE_LABELS_B[r-ROWS_PER_TEAM], state.names[r] || "", ...state.values[r].map(v=> v?String(v):"")]);
  }

  const csv = rows.map(row =>
    row.map(cell => `"${String(cell ?? "").replaceAll('"','""')}"`).join(",")
  ).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `v42_stats_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* Team settings */
document.getElementById("teamAName").addEventListener("input", (e)=>{
  state.teamAName = e.target.value;
  render(); saveToLocal();
});
document.getElementById("teamBName").addEventListener("input", (e)=>{
  state.teamBName = e.target.value;
  render(); saveToLocal();
});
document.getElementById("teamAColor").addEventListener("input", (e)=>{
  state.teamAColor = e.target.value;
  render(); saveToLocal();
});
document.getElementById("teamBColor").addEventListener("input", (e)=>{
  state.teamBColor = e.target.value;
  render(); saveToLocal();
});

document.getElementById("teamACap").addEventListener("input", (e)=>{
  state.teamACap = e.target.value.trim();
  saveToLocal();
});
document.getElementById("teamAVice").addEventListener("input", (e)=>{
  state.teamAVice = e.target.value.trim();
  saveToLocal();
});
document.getElementById("teamBCap").addEventListener("input", (e)=>{
  state.teamBCap = e.target.value.trim();
  saveToLocal();
});
document.getElementById("teamBVice").addEventListener("input", (e)=>{
  state.teamBVice = e.target.value.trim();
  saveToLocal();
});

/* Bulk roster */
document.getElementById("applyRosterBtn").addEventListener("click", ()=>{
  const lines = normalizeLines(document.getElementById("bulkRoster").value);
  if(lines.length === 0) return;

  // fill Team A first
  for(let i=0;i<Math.min(ROWS_PER_TEAM, lines.length);i++){
    state.names[i] = lines[i];
  }

  // if 24 lines, fill Team B too
  if(lines.length > ROWS_PER_TEAM){
    for(let i=0;i<Math.min(ROWS_PER_TEAM, lines.length-ROWS_PER_TEAM);i++){
      state.names[ROWS_PER_TEAM + i] = lines[ROWS_PER_TEAM + i];
    }
  }

  render();
  saveToLocal();
});

document.getElementById("clearRosterBtn").addEventListener("click", ()=>{
  document.getElementById("bulkRoster").value = "";
});

/* ---------- init ---------- */
loadFromLocal();
render();
updateUndoRedoButtons();
autoPlaceCaptains();
</script>

</body>
</html>
